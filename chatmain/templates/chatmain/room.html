<script>
    function refreshImage() {
        const img = document.getElementById("visbias-image");
        const timestamp = new Date().getTime();
        const baseSrc = "{% static 'chatmain/1.jpg' %}";
        img.src = baseSrc + "?t=" + timestamp;
    }

    const roomName = JSON.parse(document.getElementById('room-name').textContent);
    const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + roomName + '/');
    const chatLog = document.getElementById('chat-log');

    let lastSentMessage = null;

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const message = data.message;

        if (typeof message === 'object' && message !== null) {
            const bubble = document.createElement('div');
            bubble.classList.add('chat-message');

            if (lastSentMessage && message.message === lastSentMessage) {
                bubble.classList.add('own-message');
                lastSentMessage = null; // clear it after matching
            } else {
                bubble.classList.add('other-message');
            }

            bubble.innerHTML = `
                <div>${message.message}</div>
                <div class="meta">From: ${message.user} â€¢ ID: ${message.id}</div>
            `;

            chatLog.appendChild(bubble);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        refreshImage();
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.key === 'Enter') {
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        const messageInput = document.querySelector('#chat-message-input');
        const message = messageInput.value.trim();

        if (message !== '') {
            lastSentMessage = message;
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInput.value = '';
        }
    };
</script>
